%TODO: Chapter needs to be improved a lot
\documentclass[11pt,compress,t,notes=noshow, aspectratio=169, xcolor=table]{beamer}

\usepackage{../../style/lmu-lecture}
% Defines macros and environments
\input{../../style/common.tex}

\title{Interpretable Machine Learning}
% \author{LMU}
%\institute{\href{https://compstat-lmu.github.io/lecture_iml/}{compstat-lmu.github.io/lecture\_iml}}
\date{}

\begin{document}

\newcommand{\titlefigure}{figure/open_blackbox}
\newcommand{\learninggoals}{
\item Understand feature correlations and interactions
\item What are general pitfalls of interpretation methods?}

\lecturechapter{General Pitfalls}
\lecture{Interpretable Machine Learning}
%
% \begin{frame}{Interpretable ML}
% \begin{itemize}
% %\itemsep2em
% \item ML algorithms algorithmically train predictive models with no or little pre-specifications and assumptions about the data.
% \item Several algorithms such as decision tree learning create interpretable models. However, most algorithms create models which can be considered a black box.
% \item We use the term black box, although the internal workings of the model are in fact accessible, but too complex for the human mind to comprehend.
% \end{itemize}
% \end{frame}
%
% \begin{frame}{Explainable AI}
% \begin{itemize}
% %\itemsep1em
% \item IML is often used synonymously with Explainable AI (XAI).
% \item There is no unified standard for these terminologies. We find that XAI often is specifically concerned with the interpretation of neural networks, whereas IML is used as an encompassing term for everything related to model interpretability.
% \item The nature of (deep) neural networks allows for powerful model-specific interpretation techniques, e.g., layer-wise relevance propagation (LRP) and saliency maps.
% \item Also covering model-specific NN methods would exceed the timeframe of this lecture. This lecture will concentrate on model-agnostic techniques, as they are both versatile, and receive a lot of attention in industry and academia.
% \end{itemize}
% \end{frame}
%
% \begin{frame}{XAI - Saliency Maps}
%
% A saliency map is a heatmap indicating pixel influence on the prediction (e.g., a classification of an image): \footnote[frame]{Mundhenk, T., Chen, B.Y., Friedland, G. (2019). Efficient Saliency Maps for Explainable AI. ArXiv, abs/1911.11293.
% }
% \medskip
% \begin{figure}
% \includegraphics[width = 0.8 \textwidth]{figure/saliencymap}
% \end{figure}
% \end{frame}
%
% \begin{frame}{What is Interpretability?}
% \begin{itemize}
% %\itemsep1em
% \item There is no scientific consensus on the definition of interpretability.
% \item We need to differentiate between interpretations of a model or reality. The latter is distorted by all modeling fallacies involved in predictive modeling, e.g., data quality, under- and overfitting, or model extrapolations.
% \item We use a practical definition of interpretability.
% Think back to the foundations of statistical modeling:  the linear regression model (LM). The LM, with its known equation of beta coefficients, represents a paradigm for statistical interpretability.
% \item It follows that it would be beneficial to create techniques that give us an interpretation similar to the one of an LM.
%
% \end{itemize}
% \end{frame}


% \begin{frame}{Correlation and Dependence}
% \begin{itemize}
% \item \textbf{Correlation:} Often linear correlation (Pearson $\rho$) between pairs of features is meant
% \item \textbf{Dependence:} More general dependence structure (e.g., non-linear relationships)
% \item $X_j$, $X_k$ independent $\Leftrightarrow$ joint probability density function (PDF) is product of marginal PDFs:
% %$$\text{PDF}_{X_j, X_k}(x_j, x_k) = \text{PDF}_{X_j}(x_j) \cdot \text{PDF}_{X_k}(x_k)$$
% $$\P(X_j, X_k) = \P(X_j) \cdot \P(X_k)$$


% $\P(X_j|X_k) = \P(X_j)$ knowing $X_k$ does not tell us anything about $X_j$ and vice versa
% \item $X_j$, $X_k$ independent $\Rightarrow$ $X_j$, $X_k$ uncorrelated \textbf{but} $X_j$, $X_k$ uncorrelated $\nRightarrow$ $X_j$, $X_k$  independent
% %\item Auf einer slide eklären, visuell und mathematisch
% \end{itemize}

% \centering

% \only<1>{
% \textbf{Example:} $X_1$, $X_2 \sim N(0,1)$ independent ($\rho = 0$) \hspace{10pt} $X_1$, $X_2 \sim N(0,1)$ dependent ($\rho = 0.8$) \hspace{30pt}

% \includegraphics[width = 0.4\textwidth]{figure/independent}
% \includegraphics[width = 0.4\textwidth]{figure/dependent}
% }


% \only<2>{
% \includegraphics[width = 0.5\textwidth]{figure/dependence_2}
% }
% % correlation reflects the noisiness and direction of a linear relationship (top row), but not the slope of that relationship (middle), nor many aspects of nonlinear relationships (bottom). N.B.: the figure in the center has a slope of 0 but in that case the correlation coefficient is undefined because the variance of Y is zero.
% \end{frame}


\begin{frame}{Correlation and Dependence}

\textbf{Correlation:} Often Pearson correlation $\rho$ is meant, which only measures linear relationship %between pairs of features

\textbf{Example:} 

\begin{columns}[totalwidth=\textwidth]
\begin{column}{0.5\linewidth}
\centering
$X_1$, $X_2 \sim N(0,1)$ with $\rho(X_1, X_2) = 0$

\includegraphics[width = 0.7\textwidth]{figure/independent}
\end{column}
\begin{column}{0.5\linewidth}
\centering
$X_1$, $X_2 \sim N(0,1)$ with $\rho(X_1, X_2) = 0.8$

\includegraphics[width = 0.7\textwidth]{figure/dependent}
\end{column}
\end{columns}

% \hspace{40pt} $X_1$, $X_2 \sim N(0,1)$ with $\rho(X_1, X_2) = 0$ \hspace{20pt} $X_1$, $X_2 \sim N(0,1)$ with $\rho(X_1, X_2) = 0.8$

% \centering
% \includegraphics[width = 0.4\textwidth]{figure/independent}
% \hspace{20pt}
% \includegraphics[width = 0.4\textwidth]{figure/dependent}

\textbf{But:} Pearson's $\rho$ does not measure non-linear dependencies. Examples with $\rho = 0$ but dependent:

\centering
\includegraphics[width = 0.6\textwidth, trim=0 0 0 190px, clip]{figure/dependence_2}
\end{frame}



\begin{frame}{Correlation and Dependence}
\textbf{Dependence:} Describes general dependence structure of features (e.g., non-linear relationships)

%\textbf{Definition:}
\begin{itemize}
\item Definition: $X_j$, $X_k$ independent $\Leftrightarrow$ joint distribution is product of marginals:
$$\P(X_j, X_k) = \P(X_j) \cdot \P(X_k)$$
\item Equivalent definition (knowing $X_k$ does not tell us anything about $X_j$ and vice versa): \\
\medskip
\phantom{AAA} $\P(X_j|X_k) = \P(X_j) \text{ and } \P(X_k|X_j) = \P(X_k)$ \hfill (follows from conditional probability) \phantom{AAA}
%$$\P(X_j|X_k) = \P(X_j) \hfill \text{(knowing $X_k$ does not tell us anything about $X_j$ and vice versa)}$$
\medskip
\item \textbf{N.B.:} $X_j$, $X_k$ independent $\Rightarrow$ $\rho(X_j, X_k) = 0$ \textbf{but} $\rho(X_j, X_k) = 0$ $\nRightarrow$ $X_j$, $X_k$  independent
%\item Auf einer slide eklären, visuell und mathematisch
\item General dependence structure difficult to measure but many different measures exist, e.g., \\
Spearman correlation (monotonic), mutual information, or Kernel-based measures (HSCI)
\end{itemize}

\centering


\end{frame}

\begin{frame}{Interpretations with Dependent Features}
\begin{itemize}
\item Many interpretation methods create
%rely on varying feature values and create 
artificial data points which can be out-of-distribution or located in low-density regions if features are dependent\\
$\leadsto$ May produce biased explanations that rely on predictions where model extrapolated

\pause
\item Highly correlated features contain similar information \\
$\leadsto$ Can confuse a model so that only one correlated feature is used (even if it is not relevant) \\
$\leadsto$ Produced explanations are true to the model but not true to the data generating process

\pause
\item One might expect that explanations (e.g., feature importance) of correlated features are similar as they share similar information \\
$\leadsto$ Generally not true as the model can learn different relationships
% \item We need to differentiate between interpretations of a model or reality.
% \begin{itemize}
%     \item highly correlated features can confuse the fitted model in the sense that the model effectively uses only one
% \end{itemize}
%The latter is distorted by all modeling fallacies involved in predictive modeling, e.g., data quality, under- and overfitting, or model extrapolations.
\end{itemize}
\end{frame}

%%% dann das gleiche für interactions

%% wir können auch ein bsp mit feature importannce machen, wo korrelation alles schwieriger macht. im guyon paper und im i2ml featsel teil ist es drin

%% was kann mindestens zu korrel sagen:
%
% a) das extrapol problem. haben wir folien zu
% b) bei korrel kann man sagen: die vars haben die gkleich info, also breaucht man nur eine. das ist eine explanation. die kann aber falsch sein. siehe guyon bsp
% c) bei korrel könnte man sagen: die erklärungen zu vars sind die gleichen. zb deren importance. das ist aber auch nicht gegeben
% ---> generell: vorsicht!

%--------------------------------

% bei interactions:
% 1) definition davon bringen
% man kann das operationals / an der modell struktur erklären. als bsp lin modell und tree
% allgemeine definition von fanoava
% sagen dass eine funktin keine IA hat, wenn sie separierbar. verbindung zur optimierung bringen
% sagen dass man aus der fanbova die interactioons ablesen kann und auf die H-statistic für weiteres vereweisen



% \begin{frame}{Correlation vs. Interaction}
% \begin{itemize}
% %\itemsep2em
% \item Correlated (or dependent) features and feature interactions can cause misleading explanations. %One needs to be careful not to confuse them.
% \item Correlated features implies joint is not product of marginals: $\text{PDF}(x_1, \dots, x_p) \neq \text{PDF}(x_1) \cdot \ldots \cdot \text{PDF}(x_p)$.
% \item
% Many interpretation methods rely on varying feature values and may create data points that are out-of-distribution or located in low-density regions if features are correlated.\\
% $\leadsto$ May produce biased explanations that rely on predictions where the model extrapolated.
% % \item An interaction is a product term between features inside the prediction function. As such, interactions are detached from the constitution of the data, i.e., regardloss of the degree of correlation, the effect of a feature on the target will depend on the values of one or multiple other features.
% \end{itemize}
% \end{frame}

% \begin{frame}{Correlation vs. Interaction}

% 1000 randomly sampled observations with positive correlation between $x_1$ and $x_2$:
% \medskip
% \begin{figure}
% \includegraphics[width = 0.7\textwidth]{figure/correlation}
% \end{figure}
% \end{frame}

\begin{frame}{Correlation vs. Interaction}
\begin{itemize}
%\itemsep2em
\item An interaction concerns the structure of the model itself.
\item With interactions present, the effect of a feature on the prediction depends on the values of others, e.g., $\widehat{f}(x) = x_1 x_2$.
\item Although correlation concerns the data and interactions the model, they are often connected as correlations in the training data are identified by the learning algorithm.
\item Interaction terms are especially difficult to identify and analyze, as the number of potential interactions increases exponentially with the number of features.
\end{itemize}
\end{frame}

\begin{frame}{Correlation vs. Interaction}

Shape of the prediction function for a two-way interaction:

\begin{figure}
\includegraphics[width = 0.5\textwidth]{figure/interaction}
\end{figure}
\end{frame}


\begin{frame}{Extrapolation}
\begin{itemize}
%\itemsep1em
\item Predictions of an ML model in regions with a low density of training points are subject to a high variance.
\item Essentially we are interested in the prediction uncertainty, i.e., the less the training data on a feature subspace, the higher the prediction uncertainty. Unfortunately, virtually no ML models are capable of quantifying prediction uncertainty.
\item There is no consensus definition of when a model extrapolates and to what degree. Furthermore, the severity of the problem depends on the model itself. Some models might extrapolate more reliably than others.
\item Theoretically, we could use the training density as a proxy. However, density estimation in many dimensions is often infeasible.
\end{itemize}

\end{frame}

\begin{frame}{Pitfalls of Interpretation Methods}
\begin{itemize}
%\itemsep1em
\item Many methods in IML are theoretically defined for uncorrelated features, e.g., the PD or the PFI.
\item In practice, the features are usually correlated, but methods are applied regardless of potential misinterpretations.
\item Many people call for a more careful approach to conduct model interpretations, either by using intrinsically interpretable models (Rudin, 2019), or by avoiding feature permutations (Hooker, 2021).
\item There are many potential pitfalls to consider when interpreting ML models (Molnar, 2021).
\\
$\rightarrow$ Know the theory and be careful!

\footnote[frame]{Molnar, Christoph \& König, Gunnar \& Herbinger, Julia \& Freiesleben, Timo \& Dandl, Susanne \& Scholbeck, Christian \& Casalicchio, Giuseppe \& Grosse-Wentrup, Moritz \& Bischl, Bernd. (2020). Pitfalls to Avoid when Interpreting Machine Learning Models.}
\footnote[frame]{Rudin, C. Stop explaining black box machine learning models for high stakes decisions and use interpretable models instead. Nat Mach Intell 1, 206–215 (2019).}
\footnote[frame]{Hooker, Giles \& Mentch, Lucas \& Zhou, Siyu. (2021). Unrestricted permutation forces extrapolation: variable importance requires at least one more model, or there is no free variable importance. Statistics and Computing. 31. 10.1007/s11222-021-10057-z.}
\end{itemize}

\end{frame}

\endlecture
\end{document}
