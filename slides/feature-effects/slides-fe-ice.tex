\documentclass[11pt,compress,t,notes=noshow, aspectratio=169, xcolor=table]{beamer}

\usepackage{../../style/lmu-lecture}
% Defines macros and environments
\input{../../style/common.tex}

\title{Interpretable Machine Learning}
% \author{LMU}
%\institute{\href{https://compstat-lmu.github.io/lecture_iml/}{compstat-lmu.github.io/lecture\_iml}}
\date{}

\begin{document}

\newcommand{\titlefigure}{figure/feature-effect}
\newcommand{\learninggoals}{
\item Intro to feature effects
\item ICE plots
%\item Understand how to interpret ICE curves and PD plots
}

\lecturechapter{Individual Conditional Expectation (ICE) Plot}
\lecture{Interpretable Machine Learning}


\begin{frame}{Motivation}
%ICE curves show how different feature values of an observation affect its model prediction \newline $\Rightarrow$ \textbf{local interpretation method}
%From a local perspective, one might be interested in how changing feature values of an observation affect model prediction

\textbf{Question:} How does changing values of a single feature of an observation affect model prediction?

\smallskip

\textbf{Idea:} For observation and feature of interest, change values and visualize how prediction changes

\smallskip

\textbf{Example:} Prediction surface of a model (left), select observation and visualize changes in prediction for different values of feature of interest (here: $x_2$) while keeping $x_1$ fixed $\Rightarrow$ \textbf{local interpretation}

\centering
\includegraphics[width=0.85\textwidth]{figure/ice_motivation}

$\Rightarrow$ Repeat for all observations and average the curves for global feature effect ($\leadsto$ PD plots)
\end{frame}

\begin{frame}{Individual Conditional Expectation (ICE) \citebutton{Goldstein et. al (2013)}{https://doi.org/10.1080/10618600.2014.907095}}

%Consider an index set $S \subseteq \{1, \dots, p\}$ and its complement $C = S^\complement$.
%\lz
\begin{columns}[T]
\begin{column}{0.16\textwidth} % 0.2 4.26cm
\includegraphics[page=1, trim=0cm 0.35cm 4.53cm 0.35cm, clip, width=0.9\textwidth]{figure_man/ice_plot_demo}
\end{column}
\begin{column}{0.84\textwidth}

%%%

%Assume each observation $\xi$ can be partitioned into $\xi_S$ and $\xi_C$ containing only feature values from the index set $S \subseteq \{1, \dots, p\}$ and its complement $C = S^\complement$, respectively.
%Assume each observation $\xi$ can be partitioned into $\xi_S$ and $\xi_C$ containing only feature values addressed by the feature's index set $S \subseteq \{1, \dots, p\}$ and its complement $C = S^\complement$, respectively.
%Assume each observation $\xi$ can be partitioned into $\xi_S$ and $\xi_C$ containing values from features addressed by the index set $S \subseteq \{1, \dots, p\}$ and its complement $C = S^\complement$, respectively.
Partition each observation $\xv$ into $\xv_S$ and $\xv_C$ containing only feature values indexed by $S \subseteq \{1, \dots, p\}$ and its complement $C = S^\complement$.

\medskip

ICE curves visualize how prediction of observation $\xi$ changes after varying its feature values using grid points $\xv_S^*$ while keeping all other features in $C$ fixed:
%by replacing the feature values $\xv_S^{(i)}$ with other values $\xv_S$ while keeping all other features in $\xi_C$ fixed:
%by varying the feature values in $\xv_S$ while keeping all other features in $\xi_C$ fixed:
$$\fh_{S}^{(i)}(\xv_S^*) \; \text{ vs. } \; \xv_S^*$$

$\fh_{S}^{(i)}(\xv_S) = \fh(\xv_S^*, \xi_C)$ is prediction of $i$-th observation where original feature value $\xi_S$ was replaced by $\xv_S^*$.

%Visualize for \textbf{I}ndividual observations and \textbf{C}onditional on all other features how \textbf{E}xpected prediction changes

\medskip

\textbf{N.B.:} In practice, $\xv_S$ consists of one or two features ($|S| \leq 2$).

\end{column}
\end{columns}

% \begin{columns}[T, totalwidth=\textwidth]
% \begin{column}{0.6\textwidth}


% \end{column}
% \begin{column}{0.4\textwidth}
% %\begin{center}
% \centerline{\includegraphics[width=\textwidth]{figure_man/ice_bike10obs}}
% %\end{center}
% %\vspace{-0.3cm}
% \scriptsize{\textbf{Figure:} ICE Curves of 10 observations of the bike sharing dataset. Each line displays the change in prediction for a single observation due to varying the feature temperature.\par}
%
% \end{column}
% \end{columns}
%\footnote[frame]{Goldstein, A., Kapelner, A., Bleich, J., and Pitkin, E. (2013). Peeking Inside the Black Box: Visualizing Statistical Learning with Plots of Individual Conditional Expectation, 1-22. https://doi.org/10.1080/10618600.2014.907095}
\end{frame}

% \begin{frame}{Individual Conditional Expectation (ICE)}
%
% Steps to create an ICE curve of an observation regarding a single feature $x_S$ according to the \textbf{SIPA} framework:
%
% \begin{enumerate}
% \item \textbf{Sampling:} Choose grid points along $x_S$.
% \item For each grid point:
% \begin{itemize}
% \item \textbf{Intervention:} Replace the original feature value $x_S$ with the current grid value.
% \item \textbf{Prediction:} Get the model prediction with replaced feature value $x_S$.
% \end{itemize}
% \item \textbf{Aggregation:} none.
% \item \textbf{Visualization:} Draw a curve per observation with the grid points on the x-axis and the prediction on the y-axis.
% \end{enumerate}
%
% \footnote[frame]{Scholbeck, C. A., Molnar, C., Heumann, C., Bischl, B., and Casalicchio, G. (2019). Sampling, Intervention, Prediction, Aggregation: A Generalized Framework for Model Agnostic Interpretations. ECML PKDD 2019. (pp. 205-216).}
% \end{frame}

% \begin{frame}{Individual Conditional Expectation (ICE)}
%
% \begin{columns}[T]
% \begin{column}{0.4\textwidth}
% \includegraphics[page=1, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
% \end{column}
% \begin{column}{0.55\textwidth}
%
% \end{column}
% \end{columns}
% %\vspace*{\topsep}
%
% aa
% \end{frame}

\begin{frame}{Individual Conditional Expectation (ICE)}

\begin{columns}[T]
\begin{column}{0.4\textwidth}
\includegraphics[page=2, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\end{column}
\begin{column}{0.55\textwidth}

\end{column}
\end{columns}
\vspace*{\topsep}

\textbf{Grid points:}

%For the $i$-th observation, we
Sample grid values $x_S^{*^{(1)}}, \dots, x_S^{*^{(g)}}$ along feature of interest $x_S$
%(here, grid is $x_S^* = x_1^* \in \{1, 2, 3\}$)
and replace vector $\xv^{(i)}$ in data with grid
%h observation with these sampled grid values.
%$\Rightarrow$ New artificial data points for $i$-th observation.
\newline $\Rightarrow$ Creates new artificial points for the $i$-th observation

\end{frame}

\begin{frame}{Individual Conditional Expectation (ICE)}

\begin{columns}[T]
\begin{column}{0.4\textwidth}
\includegraphics<1>[page=3, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\includegraphics<2>[page=4, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\includegraphics<3>[page=5, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\end{column}
\begin{column}{0.55\textwidth}
\includegraphics<1>[page=1, width=0.85\textwidth]{figure/ICE}
\includegraphics<2>[page=2, width=0.85\textwidth]{figure/ICE}
\includegraphics<3>[page=3, width=0.85\textwidth]{figure/ICE}
\end{column}
\end{columns}
\vspace*{\topsep}

\textbf{Predict and visualize:}

For each artificially created data point of $i$-th observation, plot prediction $\fh_{S}^{(i)}(x_S^*)$ vs. grid values $x_S^*$:

$$\fh_{1}^{(i)}(x_1^*) = \fh(x_1^*, \xi_{2, 3}) \text{ vs. } x_1^* \in \{1, 2, 3\}$$

\end{frame}

% \begin{frame}{Individual Conditional Expectation (ICE)}

% \begin{columns}[T]
% \begin{column}{0.4\textwidth}
% \includegraphics[page=4, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
% \end{column}
% \begin{column}{0.55\textwidth}
% \includegraphics[page=2, width=0.85\textwidth]{figure/ICE}
% \end{column}
% \end{columns}
% \vspace*{\topsep}

% \textbf{Predict and visualize:}

% For each artificially created data point of $i$-th observation, plot prediction $\fh_{S}^{(i)}(x_S^*)$ vs. grid values $x_S^*$:

% $$\fh_{1}^{(i)}(x_1^*) = \fh(x_1^*, \xi_{2, 3}) \text{ vs. } x_1^* \in \{1, 2, 3\}$$
% \end{frame}

% \begin{frame}{Individual Conditional Expectation (ICE)}

% \begin{columns}[T]
% \begin{column}{0.4\textwidth}
% \includegraphics[page=5, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
% \end{column}
% \begin{column}{0.55\textwidth}
% \includegraphics[page=3, width=0.85\textwidth]{figure/ICE}
% \end{column}
% \end{columns}
% \vspace*{\topsep}

% \textbf{Predict and visualize:}

% For each artificially created data point of $i$-th observation, plot prediction $\fh_{S}^{(i)}(x_S^*)$ vs. grid values $x_S^*$:

% $$\fh_{1}^{(i)}(x_1^*) = \fh(x_1^*, \xi_{2, 3}) \text{ vs. } x_1^* \in \{1, 2, 3\}$$
% \end{frame}

% \begin{frame}{Individual Conditional Expectation (ICE)}

% % \begin{columns}[T]
% % \begin{column}{0.4\textwidth}
% % \includegraphics[page=5, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
% % \end{column}
% % \begin{column}{0.55\textwidth}
% % \includegraphics[page=3, width=0.85\textwidth]{figure/ICE}
% % \end{column}
% % \end{columns}
% % \vspace*{\topsep}

% \begin{itemize}
%     \item \textbf{Interpretation:} \textbf{ICE} curve visualizes for \textbf{I}ndividual observations and \textbf{C}onditional on all other features (by keeping all other features constant) how \textbf{E}xpected prediction changes
%     \item
%     \item For global view, repeat procedure for all observations
% \end{itemize}

% % \textbf{Definition:}

% % ICE curves involve plotting the pairs $ \{(x_S^{*^{(k)}}, \fh_{S}^{(i)}(x_S^*{^{(k)}})) \}_{k=1}^g $ for grid points $x_S^{*^{(1)}}, \dots, x_S^{*^{(g)}}$.
% \end{frame}

\begin{frame}{Individual Conditional Expectation (ICE)}

\begin{columns}[T]
\begin{column}{0.4\textwidth}
\includegraphics[page=6, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\end{column}
\begin{column}{0.55\textwidth}
\includegraphics[page=4, width=0.85\textwidth]{figure/ICE}
\end{column}
\end{columns}
\vspace*{\topsep}

\textbf{Repeat for other observations:}

ICE curve for $i=2$ connects all predictions at grid values associated to $i$-th observation.
\end{frame}

\begin{frame}{Individual Conditional Expectation (ICE)}

\begin{columns}[T]
\begin{column}{0.4\textwidth}
\includegraphics[page=7, trim=0cm 0.35cm 0.85cm 0.35cm, width=0.9\textwidth]{figure_man/ice_plot_demo}
\end{column}
\begin{column}{0.55\textwidth}
%\begin{center}
\includegraphics[page=5, width=0.85\textwidth]{figure/ICE}
%\end{center}
\end{column}
\end{columns}
\vspace*{\topsep}

\textbf{Repeat for other observations:}

ICE curve for $i=3$ connects all predictions at grid values associated to $i$-th observation.
%The ICE curve of observation $i=3$ connects all predictions at the corresponding grid values associated to the $i$-th observation.

% \textbf{Definition:}

% ICE curves involve plotting the pairs $ \{(x_S^{*^{(k)}}, \fh_{S}^{(i)}(x_S^*{^{(k)}})) \}_{k=1}^g $ for grid points $x_S^{*^{(1)}}, \dots, x_S^{*^{(g)}}$.
\end{frame}


\begin{frame}{Comments on Grid values}
\begin{itemize}
%\item ICE curves show how different feature values of an observation affect its prediction \newline $\Rightarrow$ \textbf{local interpretation method}
\item Plotting ICE curves involves generating grid values $x_S^*$ that are visualized on the x-axis
\item Common choices for grid values are
\begin{itemize}
\item equidistant grid values within feature range
\item randomly sampled values or quantile values of observed feature values
\end{itemize}
\item Except equidistant grid, the other two options preserve (approximately) the marginal distribution of feature of interest
$\Rightarrow$ Avoids unrealistic feature values for distributions with outliers %or dependencies

\vspace{3pt}
\centering
\includegraphics[width=0.75\textwidth, trim=0cm 0cm 0cm 0cm, clip]{figure/sampling}

%Preferable for skewed distributions (with outliers) to avoid using unrealistic feature values.
% \begin{itemize}
% \item equidistant grid values:
% \item sub-sampled grid values:
% \item quantile grid values:
% \end{itemize}
\end{itemize}
\end{frame}

\endlecture
\end{document}
